# HT-023.1.1 Template Engine Architecture Design

## Overview

Simple template engine architecture designed for rapid customization, client branding, and custom micro-app template management. Built to enable ≤7 day delivery cycles with AI assistance.

## Core Architecture

### 1. Template Engine Foundation

```typescript
// lib/template-engine/core/engine.ts
interface TemplateEngine {
  compose(template: Template, data: TemplateData): ComposedTemplate;
  render(composed: ComposedTemplate): RenderedOutput;
  validate(template: Template): ValidationResult;
  version(template: Template): VersionedTemplate;
}

interface Template {
  id: string;
  name: string;
  version: string;
  type: 'page' | 'component' | 'layout';
  schema: TemplateSchema;
  content: TemplateContent;
  metadata: TemplateMetadata;
  inheritance?: TemplateInheritance;
  branding?: ClientBranding;
}
```

### 2. Template Composition System

**Layered Composition Architecture:**
- **Base Layer**: Foundation templates with core structure
- **Theme Layer**: Client branding and visual customization
- **Content Layer**: Dynamic content and data binding
- **Behavior Layer**: Interactive features and micro-interactions

```typescript
// lib/template-engine/composition/composer.ts
interface TemplateComposer {
  composeFromBase(baseId: string, overrides: TemplateOverrides): Template;
  mergeInheritance(parent: Template, child: Template): Template;
  applyBranding(template: Template, branding: ClientBranding): Template;
  resolveConflicts(layers: TemplateLayer[]): ResolvedTemplate;
}
```

### 3. Client Branding Integration

**Branding Configuration:**
```typescript
// lib/template-engine/branding/types.ts
interface ClientBranding {
  id: string;
  clientId: string;
  colorPalette: BrandColors;
  typography: BrandTypography;
  spacing: BrandSpacing;
  components: BrandComponentOverrides;
  assets: BrandAssets;
  customCss?: string;
}

interface BrandColors {
  primary: string;
  secondary: string;
  accent: string;
  neutral: ColorScale;
  semantic: SemanticColors;
}
```

**Integration Points:**
- Design token override system
- Component variant mapping
- Asset replacement pipeline
- CSS custom property injection

### 4. Template Versioning System

**Version Management:**
```typescript
// lib/template-engine/versioning/manager.ts
interface TemplateVersion {
  version: string;
  timestamp: Date;
  changes: VersionChange[];
  compatibility: CompatibilityInfo;
  rollbackPoint: boolean;
}

interface VersionManager {
  createVersion(template: Template): TemplateVersion;
  compareVersions(v1: string, v2: string): VersionComparison;
  rollback(templateId: string, targetVersion: string): RollbackResult;
  migrateTemplate(template: Template, targetVersion: string): MigrationResult;
}
```

### 5. Template Inheritance Patterns

**Inheritance Hierarchy:**
```
Base Templates
├── Layout Templates
│   ├── Single Page App
│   ├── Multi-page Website
│   └── Dashboard Layout
├── Page Templates
│   ├── Landing Page
│   ├── Form Page
│   ├── Dashboard Page
│   └── Content Page
└── Component Templates
    ├── Hero Sections
    ├── Form Components
    ├── Navigation
    └── Footer Components
```

**Inheritance Rules:**
```typescript
// lib/template-engine/inheritance/patterns.ts
interface InheritancePattern {
  overrideStrategy: 'merge' | 'replace' | 'extend';
  conflictResolution: 'parent' | 'child' | 'explicit';
  cascadeRules: CascadeRule[];
  validationRules: InheritanceValidation[];
}
```

## Implementation Architecture

### Directory Structure
```
lib/template-engine/
├── core/
│   ├── engine.ts           # Main template engine
│   ├── parser.ts           # Template parsing
│   ├── renderer.ts         # Template rendering
│   └── validator.ts        # Template validation
├── composition/
│   ├── composer.ts         # Template composition
│   ├── merger.ts           # Layer merging
│   └── resolver.ts         # Conflict resolution
├── branding/
│   ├── manager.ts          # Branding management
│   ├── applier.ts          # Branding application
│   └── types.ts            # Branding types
├── versioning/
│   ├── manager.ts          # Version management
│   ├── migrator.ts         # Template migration
│   └── storage.ts          # Version storage
├── inheritance/
│   ├── resolver.ts         # Inheritance resolution
│   ├── patterns.ts         # Inheritance patterns
│   └── validator.ts        # Inheritance validation
└── templates/
    ├── base/               # Base templates
    ├── layouts/            # Layout templates
    ├── pages/              # Page templates
    └── components/         # Component templates
```

### Database Schema
```sql
-- Template storage
CREATE TABLE templates (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  name TEXT NOT NULL,
  type template_type NOT NULL,
  version TEXT NOT NULL,
  schema JSONB NOT NULL,
  content JSONB NOT NULL,
  metadata JSONB NOT NULL,
  parent_id UUID REFERENCES templates(id),
  created_at TIMESTAMP DEFAULT NOW(),
  updated_at TIMESTAMP DEFAULT NOW()
);

-- Client branding
CREATE TABLE client_branding (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  client_id UUID NOT NULL,
  name TEXT NOT NULL,
  config JSONB NOT NULL,
  assets JSONB,
  created_at TIMESTAMP DEFAULT NOW(),
  updated_at TIMESTAMP DEFAULT NOW()
);

-- Template versions
CREATE TABLE template_versions (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  template_id UUID REFERENCES templates(id),
  version TEXT NOT NULL,
  changes JSONB,
  rollback_point BOOLEAN DEFAULT FALSE,
  created_at TIMESTAMP DEFAULT NOW()
);
```

## Technical Integration

### 1. Next.js Integration
- Server-side template compilation
- Dynamic route generation
- Static site generation support
- Edge runtime compatibility

### 2. Component System Integration
- shadcn/ui component mapping
- Radix UI primitive extension
- Custom component registration
- Theme provider integration

### 3. Style System Integration
- Style Dictionary token injection
- Tailwind CSS class generation
- CSS custom property management
- Runtime theme switching

### 4. Build System Integration
- Template pre-compilation
- Asset optimization
- Bundle splitting by template
- Development hot-reload

## Performance Considerations

### Template Caching
- Compiled template caching
- Version-based cache invalidation
- Edge caching for static templates
- Progressive template loading

### Memory Management
- Lazy template loading
- Template garbage collection
- Memory pool for frequent templates
- Streaming for large templates

### Compilation Optimization
- Template tree shaking
- Unused component elimination
- CSS purging by template
- Asset optimization pipeline

## Security & Validation

### Template Security
- XSS prevention in templates
- Script injection protection
- Asset validation
- Content sanitization

### Schema Validation
- Template structure validation
- Data binding validation
- Component prop validation
- Brand configuration validation

## API Design

### Template Engine API
```typescript
// lib/template-engine/api/engine.ts
export class TemplateEngineAPI {
  async createTemplate(spec: TemplateSpec): Promise<Template>;
  async updateTemplate(id: string, changes: TemplateChanges): Promise<Template>;
  async composeTemplate(id: string, data: TemplateData): Promise<ComposedTemplate>;
  async renderTemplate(composed: ComposedTemplate): Promise<RenderedOutput>;
  async applyBranding(templateId: string, brandingId: string): Promise<BrandedTemplate>;
  async createVersion(templateId: string): Promise<TemplateVersion>;
  async rollbackTemplate(templateId: string, version: string): Promise<Template>;
}
```

### Client Integration API
```typescript
// lib/template-engine/api/client.ts
export class ClientTemplateAPI {
  async getAvailableTemplates(clientId: string): Promise<Template[]>;
  async customizeTemplate(templateId: string, customization: Customization): Promise<Template>;
  async previewTemplate(templateId: string, data: PreviewData): Promise<PreviewResult>;
  async deployTemplate(templateId: string, config: DeployConfig): Promise<DeployResult>;
}
```

## Verification Checkpoints Status

✅ **Template engine architecture designed**
- Core engine interface and composition system defined
- Layered architecture with clear separation of concerns
- Integration points with existing Next.js/React ecosystem

✅ **Template composition system planned**
- Four-layer composition: Base, Theme, Content, Behavior
- Conflict resolution and merge strategies defined
- Component-based composition with inheritance support

✅ **Client branding integration designed**
- Comprehensive branding configuration interface
- Design token override system
- Asset replacement and CSS injection pipeline
- Integration with existing style system

✅ **Template versioning system planned**
- Version management with rollback capabilities
- Change tracking and compatibility validation
- Migration system for template updates
- Database schema for version storage

✅ **Template inheritance patterns defined**
- Clear inheritance hierarchy with base/layout/page/component levels
- Override strategies and conflict resolution rules
- Validation system for inheritance chains
- Pattern-based inheritance with customization points

## Next Steps

This architecture provides the foundation for HT-023.1.2 (Responsive Design System) and subsequent phases. The design emphasizes:

1. **Simplicity**: Clear interfaces and minimal complexity
2. **Extensibility**: Plugin-based architecture for future enhancements
3. **Performance**: Caching and optimization strategies
4. **Developer Experience**: Type-safe APIs and clear abstractions
5. **Client Focus**: Rapid customization and branding capabilities

The architecture is ready for implementation in Phase 2 (Form Builder & User Input System).